<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIA Chat Inteligente</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: sans-serif;
      background: #7367f0;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #chat {
      width: 100%;
      max-width: 420px;
      height: 60vh;
      background: white;
      color: black;
      border-radius: 10px;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .user { background: #8e24aa; color: #fff; align-self: flex-end; border-radius: 20px; padding: 10px; }
    .lia { background: #e1bee7; color: #222; align-self: flex-start; border-radius: 20px; padding: 10px; }
    .lia a { color: #6a1b9a; text-decoration: underline; }
    #inputArea {
      margin-top: 10px;
      display: flex;
      gap: 6px;
      width: 100%;
      max-width: 420px;
    }
    #input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 2px solid #8e24aa;
    }
    button {
      padding: 10px 14px;
      border: none;
      border-radius: 20px;
      background: #8e24aa;
      color: white;
      cursor: pointer;
      font-size: 1.2em;
    }
  </style>
</head>
<body>

<div id="chat" aria-live="polite"></div>

<div id="inputArea">
  <input id="input" placeholder="EscribÃ­ algo..." autocomplete="off" />
  <button id="sendBtn">ğŸ’Œ</button>
  <button id="micBtn">ğŸ¤</button>
</div>

<script>
const API_KEY = 'AIzaSyCPafK6G0bNRhRR_WVXIr1EZW-UHTk-0k8';
const CX = '232b2051090784dc2';

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');

function scrollToBottom() {
  chat.scrollTop = chat.scrollHeight;
}

function addMessage(text, sender = 'lia') {
  const div = document.createElement('div');
  div.className = sender === 'user' ? 'user' : 'lia';
  div.innerHTML = text;
  chat.appendChild(div);
  scrollToBottom();
}

async function buscarGoogle(query) {
  try {
    const url = `https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CX}&q=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    const data = await res.json();
    console.log('ğŸ“¡ Google API data:', data);
    return data.items || [];
  } catch (err) {
    console.error('âŒ Error al buscarGoogle:', err);
    addMessage(`ğŸš¨ <b>Error al buscar:</b><br>${err.message}`);
    return [];
  }
}

function elegirRespuesta(texto) {
  const t = texto.toLowerCase();
  if (t.includes('hola')) return 'Â¡Hola, papÃ¡! ğŸ’•';
  if (t.includes('cÃ³mo estÃ¡s')) return 'Â¡Muy bien! Â¿Y vos, papÃ¡? ğŸ¥°';
  if (t.includes('gracias')) return 'Â¡De nada, papÃ¡! ğŸ˜Š';
  if (t.includes('adiÃ³s') || t.includes('chau') || t.includes('bye')) return 'Â¡Hasta luego! Te espero para seguir charlando ğŸ«¶';

  if (t.includes('lista de frutas') || t.includes('frutas') || t.includes('fruta')) {
    return `<b>Lista de frutas:</b><ul>
      <li>Manzana ğŸ</li>
      <li>Banana ğŸŒ</li>
      <li>Naranja ğŸŠ</li>
      <li>Frutilla ğŸ“</li>
      <li>Mango ğŸ¥­</li>
      <li>Uvas ğŸ‡</li>
    </ul>`;
  }

  return 'No entendÃ­ muy bien... ğŸ˜…';
}

async function sendMessage() {
  try {
    const texto = input.value.trim();
    if (!texto) return;

    addMessage(texto, 'user');
    input.value = '';
    input.disabled = true;

    if (texto.toLowerCase().startsWith('busca ') || texto.toLowerCase().startsWith('google ')) {
      addMessage('ğŸ” Buscando en Google...');
      const query = texto.replace(/^busca |^google /i, '');
      const resultados = await buscarGoogle(query);
      if (resultados.length === 0) {
        addMessage('No encontrÃ© nada ğŸ˜•');
      } else {
        resultados.slice(0, 3).forEach(item => {
          const msg = `<a href="${item.link}" target="_blank">${item.title}</a><br>${item.snippet}`;
          addMessage(msg);
        });
      }
    } else {
      const respuesta = elegirRespuesta(texto);
      addMessage(respuesta);
    }

  } catch (err) {
    console.error('ğŸ›‘ Error interno en sendMessage:', err);
    addMessage(`ğŸš¨ <b>Error interno:</b><br>${err.message}`);
  } finally {
    input.disabled = false;
    input.focus();
  }
}

// Reconocimiento de voz ğŸ¤
micBtn.onclick = () => {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert('Tu navegador no soporta reconocimiento de voz.');
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'es-AR';
  recognition.onresult = e => {
    const texto = e.results[0][0].transcript;
    input.value = texto;
    sendMessage();
  };
  recognition.onerror = e => {
    console.error('ğŸ¤ Error en voz:', e.error);
    addMessage(`ğŸ¤ Error de voz: ${e.error}`);
  };
  recognition.start();
};

// EnvÃ­o por enter
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
sendBtn.onclick = sendMessage;

// Captura global de errores
window.onerror = function (message, source, lineno, colno, error) {
  const msg = `ğŸš¨ <b>Error global</b>: ${message} <br> LÃ­nea: ${lineno}, Col: ${colno}`;
  console.error('ğŸ›‘ Global JS Error:', message, source, lineno, colno, error);
  addMessage(msg);
  return true;
};

// Bienvenida
window.onload = () => {
  setTimeout(() => addMessage('Â¡Hola, papÃ¡! Â¿QuerÃ©s charlar conmigo? ğŸ˜„'), 500);
};
</script>

</body>
</html>
