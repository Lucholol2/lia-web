<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LIA - Chat Inteligente</title>
<style>
  body, input, button { font-family:sans-serif; }
  body { margin:20px; background:#7367f0; color:#fff; display:flex; flex-direction:column; align-items:center; }
  #chat { width: 100%; max-width: 400px; height: 60vh; background:#fff; color:#000; border-radius:10px; overflow-y:auto; padding:10px; }
  .user, .lia { margin:6px; padding:10px; border-radius:12px; max-width: 75%; }
  .user { background:#8e24aa; color:#fff; align-self:flex-end; }
  .lia { background:#e1bee7; color:#222; align-self:flex-start; }
  #inputArea { margin-top:8px; display:flex; width:100%; max-width:400px; }
  #input { flex:1; padding:8px; border-radius:20px; border:1px solid #8e24aa; outline:none; }
  button { margin-left:6px; padding:8px 14px; border:none; border-radius:20px; background:#8e24aa; color:#fff; cursor:pointer; }
  button.active { background:#c64bd1; }
  a { color:#6a1b9a; text-decoration:underline; }
</style>
</head>
<body>

<h2>LIA ðŸ’–</h2>
<div id="chat"></div>
<div id="inputArea">
  <input id="input" placeholder="EscribÃ­ algo..." autocomplete="off" />
  <button id="micBtn" title="Hablar">&#127908;</button>
  <button id="sendBtn" title="Enviar">ðŸ’Œ</button>
</div>

<script>
const API_KEY = 'AIzaSyCPafK6G0bNRhRR_WVXIr1EZW-UHTk-0k8';
const CX = '232b2051090784dc2';

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const micBtn = document.getElementById('micBtn');
const sendBtn = document.getElementById('sendBtn');

function addMsg(text, cls) {
  const div = document.createElement('div');
  div.className = cls;
  if(cls === 'lia' && text.includes('<a ')) div.innerHTML = text;
  else div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function googleSearch(q) {
  try {
    const res = await fetch(`https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CX}&q=${encodeURIComponent(q)}`);
    if(!res.ok) throw 'Error en bÃºsqueda';
    const data = await res.json();
    return data.items || [];
  } catch(e) {
    addMsg('Error al buscar: ' + e, 'lia');
    return [];
  }
}

function speak(text) {
  if(!window.speechSynthesis) return;
  const synth = window.speechSynthesis;
  let voices = synth.getVoices();
  if(!voices.length) {
    synth.onvoiceschanged = () => speak(text);
    return;
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = voices.find(v => v.lang === 'es-AR') || voices.find(v => v.lang.startsWith('es')) || voices[0];
  utter.lang = utter.voice.lang;
  synth.cancel();
  synth.speak(utter);
}

async function sendMessage() {
  const text = input.value.trim();
  if(!text) return;
  addMsg(text, 'user');
  input.value = '';
  input.disabled = true;

  if(text.toLowerCase().startsWith('busca ') || text.toLowerCase().startsWith('google ')) {
    addMsg('ðŸ”Ž Buscando en Google...', 'lia');
    const query = text.replace(/^busca |^google /i, '');
    const results = await googleSearch(query);
    if(results.length === 0) addMsg('No encontrÃ© nada ðŸ˜•', 'lia');
    else results.slice(0,3).forEach(r => {
      addMsg(`<a href="${r.link}" target="_blank">${r.title}</a><br>${r.snippet}`, 'lia');
    });
  } else {
    const reply = simpleResponse(text);
    addMsg(reply, 'lia');
    speak(reply);
  }
  input.disabled = false;
  input.focus();
}

function simpleResponse(input) {
  input = input.toLowerCase();
  if(input.includes('hola')) return 'Â¡Hola, papÃ¡! ðŸ’•';
  if(input.includes('cÃ³mo estÃ¡s')) return 'Â¡Muy bien! Â¿Y vos? ðŸ¥°';
  if(input.includes('adiÃ³s')) return 'Â¡Hasta luego! ðŸ«¶';
  return 'No entendÃ­ muy bien... ðŸ˜…';
}

// Voz
let recognition;
if('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'es-AR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onresult = e => {
    input.value = e.results[0][0].transcript;
    sendMessage();
    toggleMic(false);
  };
  recognition.onerror = () => { addMsg('No pude escucharte bien ðŸ˜•', 'lia'); toggleMic(false); };
  recognition.onend = () => toggleMic(false);
}

function toggleMic(on) {
  if(on) {
    micBtn.classList.add('active');
    recognition.start();
  } else {
    micBtn.classList.remove('active');
    recognition.stop();
  }
}

micBtn.onclick = () => {
  if(micBtn.classList.contains('active')) toggleMic(false);
  else toggleMic(true);
};

sendBtn.onclick = sendMessage;
input.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

window.onload = () => {
  addMsg('Â¡Hola, papÃ¡! Â¿QuerÃ©s charlar conmigo? ðŸ˜„', 'lia');
  input.focus();
};
</script>

</body>
</html>
