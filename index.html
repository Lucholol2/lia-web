<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LIA Chat con Google Search y Voz</title>
<style>
  body, input, button { font-family: sans-serif; }
  body { margin: 20px; background: #7367f0; color: #fff; display: flex; flex-direction: column; align-items: center; }
  #chat { width: 100%; max-width: 400px; height: 60vh; background: #fff; color: #000; border-radius: 10px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
  .user { background: #8e24aa; color: #fff; padding: 10px 14px; border-radius: 20px; max-width: 70%; align-self: flex-end; word-break: break-word; }
  .lia { background: #e1bee7; color: #222; padding: 10px 14px; border-radius: 20px; max-width: 70%; align-self: flex-start; word-break: break-word; }
  .lia a { color: #6a1b9a; text-decoration: underline; }
  #inputArea { margin-top: 10px; display: flex; gap: 8px; width: 100%; max-width: 400px; }
  #input { flex-grow: 1; padding: 10px 14px; border-radius: 25px; border: 2px solid #8e24aa; font-size: 1em; outline: none; }
  #input:focus { border-color: #6a1b9a; }
  button { padding: 10px 16px; border-radius: 25px; border: none; background: #8e24aa; color: white; cursor: pointer; font-size: 1.2em; box-shadow: 0 2px 8px #6a1b9aaa; user-select: none; }
  button:hover { background: #6a1b9a; }
</style>
</head>
<body>

<div id="chat" aria-live="polite"></div>

<div id="inputArea">
  <input id="input" placeholder="EscribÃ­ algo..." autocomplete="off" />
  <button id="sendBtn" title="Enviar">ðŸ’Œ</button>
  <button id="micBtn" title="Hablar">ðŸŽ¤</button>
</div>

<script>
  const API_KEY = 'AIzaSyCPafK6G0bNRhRR_WVXIr1EZW-UHTk-0k8';
  const CX = '232b2051090784dc2';

  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const micBtn = document.getElementById('micBtn');

  function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
  }

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.className = sender === 'user' ? 'user' : 'lia';
    // Permitir links en mensajes de LIA
    if(sender === 'lia' && text.includes('<a ')) {
      div.innerHTML = text;
    } else {
      div.textContent = text;
    }
    chat.appendChild(div);
    scrollToBottom();
  }

  async function buscarGoogle(query) {
    try {
      const url = `https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CX}&q=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Error en bÃºsqueda');
      const data = await res.json();
      return data.items || [];
    } catch (e) {
      console.error('Error en buscarGoogle:', e);
      addMessage(`Error al buscar: ${e.message}`, 'lia');
      return [];
    }
  }

  async function sendMessage() {
    const texto = input.value.trim();
    if (!texto) return;

    addMessage(texto, 'user');
    input.value = '';
    input.disabled = true;

    if (texto.toLowerCase().startsWith('busca ') || texto.toLowerCase().startsWith('google ')) {
      addMessage('ðŸ”Ž Buscando en Google...', 'lia');
      const query = texto.replace(/^busca |^google /i, '');
      const resultados = await buscarGoogle(query);

      if (resultados.length === 0) {
        addMessage('No encontrÃ© nada ðŸ˜•', 'lia');
      } else {
        resultados.slice(0, 3).forEach(item => {
          const link = `<a href="${item.link}" target="_blank" rel="noopener">${item.title}</a><br>${item.snippet}`;
          addMessage(link, 'lia');
        });
      }
    } else {
      // Respuestas simples cuando no es bÃºsqueda
      const respuesta = elegirRespuesta(texto);
      addMessage(respuesta, 'lia');
    }

    input.disabled = false;
    input.focus();
  }

  // Respuestas simples
  function elegirRespuesta(input) {
    input = input.toLowerCase();
    if (input.includes('hola')) return 'Â¡Hola, papÃ¡! ðŸ’•';
    if (input.includes('cÃ³mo estÃ¡s')) return 'Â¡Muy bien! Â¿Y vos, papÃ¡? ðŸ¥°';
    if (input.includes('gracias')) return 'Â¡De nada, papÃ¡! ðŸ˜Š';
    if (input.includes('adiÃ³s') || input.includes('chau') || input.includes('bye')) return 'Â¡Hasta luego! Te espero para seguir charlando ðŸ«¶';
    return 'No entendÃ­ muy bien... ðŸ˜…';
  }

  sendBtn.onclick = sendMessage;
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  micBtn.onclick = () => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert('Este navegador no soporta reconocimiento de voz.');
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'es-AR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.start();
    recognition.onresult = e => {
      const spoken = e.results[0][0].transcript;
      input.value = spoken;
      sendMessage();
    };
    recognition.onerror = e => {
      alert('Error en reconocimiento de voz: ' + e.error);
    };
  };

  // Mensaje de bienvenida al cargar
  window.onload = () => {
    setTimeout(() => addMessage('Â¡Hola, papÃ¡! Â¿QuerÃ©s charlar conmigo? ðŸ˜„', 'lia'), 500);
  };
</script>

</body>
</html>
