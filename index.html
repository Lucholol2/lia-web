<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat LIA con Google Search</title>
<style>
  body, input, button { font-family: sans-serif; }
  body {
    margin: 20px;
    background: #7367f0;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #chat-box {
    width: 100%;
    max-width: 400px;
    height: 60vh;
    background: #fff;
    color: #000;
    border-radius: 10px;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .user-message {
    background: #8e24aa;
    color: #fff;
    padding: 10px 14px;
    border-radius: 20px;
    max-width: 70%;
    align-self: flex-end;
    word-break: break-word;
  }
  .lia-message {
    background: #e1bee7;
    color: #222;
    padding: 10px 14px;
    border-radius: 20px;
    max-width: 70%;
    align-self: flex-start;
    word-break: break-word;
  }
  .lia-message a {
    color: #6a1b9a;
    text-decoration: underline;
  }
  #input-area {
    margin-top: 10px;
    display: flex;
    gap: 8px;
    width: 100%;
    max-width: 400px;
  }
  #user-input {
    flex-grow: 1;
    padding: 10px 14px;
    border-radius: 25px;
    border: 2px solid #8e24aa;
    font-size: 1em;
    outline: none;
  }
  #user-input:focus {
    border-color: #6a1b9a;
  }
  button {
    padding: 10px 16px;
    border-radius: 25px;
    border: none;
    background: #8e24aa;
    color: white;
    cursor: pointer;
    font-size: 1.2em;
    box-shadow: 0 2px 8px #6a1b9aaa;
    user-select: none;
  }
  button:hover {
    background: #6a1b9a;
  }
</style>
</head>
<body>

<div id="chat-box" aria-live="polite"></div>

<div id="input-area">
  <input id="user-input" placeholder="Escribí algo..." autocomplete="off" />
  <button id="send-btn" title="Enviar">💌</button>
</div>

<script>
  const API_KEY = 'AIzaSyCPafK6G0bNRhRR_WVXIr1EZW-UHTk-0k8';
  const CX = '232b2051090784dc2';

  const chatBox = document.getElementById('chat-box');
  const userInput = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');

  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function agregarMensaje(texto, clase) {
    const div = document.createElement('div');
    div.className = clase;
    if (clase === 'lia-message') {
      div.innerHTML = texto;  // Aquí permitimos HTML para mensajes IA
    } else {
      div.textContent = texto;
    }
    chatBox.appendChild(div);
    scrollToBottom();
  }

  async function buscarGoogle(query) {
    try {
      const url = `https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CX}&q=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Error en búsqueda');
      const data = await res.json();
      return data.items || [];
    } catch (e) {
      agregarMensaje(`Error al buscar: ${e.message}`, 'lia-message');
      return [];
    }
  }

  async function sendMessage() {
    const texto = userInput.value.trim();
    if (!texto) return;

    agregarMensaje(texto, 'user-message');
    userInput.value = '';
    userInput.disabled = true;

    if (texto.toLowerCase().startsWith('busca ') || texto.toLowerCase().startsWith('google ')) {
      agregarMensaje('🔎 Buscando en Google...', 'lia-message');
      const query = texto.replace(/^busca |^google /i, '');
      const resultados = await buscarGoogle(query);

      if (resultados.length === 0) {
        agregarMensaje('No encontré nada 😕', 'lia-message');
      } else {
        resultados.slice(0, 3).forEach(item => {
          const link = `<a href="${item.link}" target="_blank" rel="noopener">${item.title}</a><br>${item.snippet}`;
          agregarMensaje(link, 'lia-message');
        });
      }
    } else {
      const respuesta = elegirRespuesta(texto);
      agregarMensaje(respuesta, 'lia-message');
    }

    userInput.disabled = false;
    userInput.focus();
  }

  function elegirRespuesta(input) {
    input = input.toLowerCase();

    if (
      input.includes('lista de frutas') ||
      input.includes('lista de fruta') ||
      input.includes('frutas') ||
      input.includes('fruta')
    ) {
      return `<b>Lista de frutas:</b><ul>
        <li>Manzana 🍎</li>
        <li>Banana 🍌</li>
        <li>Naranja 🍊</li>
        <li>Frutilla 🍓</li>
        <li>Mango 🥭</li>
        <li>Uvas 🍇</li>
      </ul>`;
    }

    if (input.includes('hola')) return '¡Hola, papá! 💕';
    if (input.includes('cómo estás')) return '¡Muy bien! ¿Y vos, papá? 🥰';
    if (input.includes('gracias')) return '¡De nada, papá! 😊';
    if (input.includes('adiós') || input.includes('chau') || input.includes('bye')) return '¡Hasta luego! Te espero para seguir charlando 🫶';

    return 'No entendí muy bien... 😅';
  }

  sendBtn.onclick = sendMessage;

  userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  window.onload = () => {
    setTimeout(() => agregarMensaje('¡Hola, papá! ¿Querés charlar conmigo? 😄', 'lia-message'), 500);
  };
</script>

</body>
</html>
