<script>
const API_KEY = 'AIzaSyCPafK6G0bNRhRR_WVXIr1EZW-UHTk-0k8';
const CX = '232b2051090784dc2';

const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');

function scrollToBottom() {
  chatBox.scrollTop = chatBox.scrollHeight;
}

function agregarMensaje(texto, clase) {
  const div = document.createElement('div');
  div.className = clase;
  div.innerHTML = texto;
  chatBox.appendChild(div);
  scrollToBottom();
}

// ✅ Corrección automática de errores comunes
function autocorregir(texto) {
  const mapaErrores = {
    'frtua': 'fruta',
    'frtutas': 'frutas',
    'frtita': 'frutilla',
    'buska': 'busca',
    'gogle': 'google',
    'googl': 'google',
    'lista de frtutas': 'lista de frutas',
    'oras': 'hora',
  };

  for (let error in mapaErrores) {
    const regex = new RegExp(`\\b${error}\\b`, 'gi');
    texto = texto.replace(regex, mapaErrores[error]);
  }

  return texto;
}

async function buscarGoogle(query) {
  try {
    const url = `https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CX}&q=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Error en búsqueda');
    const data = await res.json();
    return data.items || [];
  } catch (e) {
    console.error('Error en buscarGoogle:', e);
    agregarMensaje(`Error al buscar: ${e.message}`, 'lia-message');
    return [];
  }
}

async function sendMessage() {
  let texto = userInput.value.trim();
  if (!texto) return;

  texto = autocorregir(texto); // ✅ Corrige errores antes de procesar
  agregarMensaje(texto, 'user-message');
  userInput.value = '';
  userInput.disabled = true;

  if (texto.toLowerCase().startsWith('busca ') || texto.toLowerCase().startsWith('google ')) {
    agregarMensaje('🔎 Buscando en Google...', 'lia-message');
    const query = texto.replace(/^busca |^google /i, '');
    const resultados = await buscarGoogle(query);

    if (resultados.length === 0) {
      agregarMensaje('No encontré nada 😕', 'lia-message');
    } else {
      resultados.slice(0, 3).forEach(item => {
        const link = `<a href="${item.link}" target="_blank" rel="noopener">${item.title}</a><br>${item.snippet}`;
        agregarMensaje(link, 'lia-message');
      });
    }
  } else {
    const respuesta = elegirRespuesta(texto);
    agregarMensaje(respuesta, 'lia-message');
  }

  userInput.disabled = false;
  userInput.focus();
}

function elegirRespuesta(input) {
  input = input.toLowerCase();

  // ✅ Responde con hora actual
  if (input.includes('hora')) {
    const ahora = new Date();
    const hora = ahora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
    return `⏰ La hora actual es ${hora}`;
  }

  if (
    input.includes('lista de frutas') ||
    input.includes('lista de fruta') ||
    input.includes('frutas') ||
    input.includes('fruta')
  ) {
    return `<b>Lista de frutas:</b><ul>
      <li>Manzana 🍎</li>
      <li>Banana 🍌</li>
      <li>Naranja 🍊</li>
      <li>Frutilla 🍓</li>
      <li>Mango 🥭</li>
      <li>Uvas 🍇</li>
    </ul>`;
  }

  if (input.includes('hola')) return '¡Hola, papá! 💕';
  if (input.includes('cómo estás')) return '¡Muy bien! ¿Y vos, papá? 🥰';
  if (input.includes('gracias')) return '¡De nada, papá! 😊';
  if (input.includes('adiós') || input.includes('chau') || input.includes('bye')) return '¡Hasta luego! Te espero para seguir charlando 🫶';

  return 'No entendí muy bien... 😅';
}

userInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

window.onload = () => {
  setTimeout(() => agregarMensaje('¡Hola, papá! ¿Querés charlar conmigo? 😄', 'lia-message'), 500);
};
</script>
